<h1 id="-">服务端渲染</h1>
<p>使用 Stencil 的一个优点，是开启高效的服务端渲染 (SSR) 非常容易，不需要运行耗费资源的无头浏览器。此外，决定在服务端渲染每个页面之前，你最好看一下<a href="/docs/prerendering">预渲染</a>的内容。</p>
<p>Stencil 支持 Node.js 服务，并且 SSR 渲染引擎已经内嵌到  <code>@stencil/core</code> 包里了。要查看完整的例子，请看 <a href="https://github.com/ionic-team/stencil-ssr-starter">Stencil SSR Starter</a>。</p>
<h2 id="stencil-ssr-express-">Stencil SSR Express 中间件</h2>
<p>最简单的开启 SSR 的方法是使用 Express 中间件：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> express = require(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> stencil = require(<span class="hljs-string">'@stencil/core/server'</span>);

<span class="hljs-comment">// 创建 express app</span>
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// 设置 express 端口</span>
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3030</span>;

<span class="hljs-comment">// 载入 stencil 设置</span>
<span class="hljs-keyword">const</span> <span class="hljs-built_in">config</span> = stencil.loadConfig(__dirname);

<span class="hljs-comment">// 服务端渲染 html 页面</span>
app.use(stencil.ssrPathRegex, stencil.ssrMiddleware({ <span class="hljs-built_in">config</span> }));

<span class="hljs-comment">// 从 www 文件夹托管所有静态文件</span>
app.use(express.<span class="hljs-keyword">static</span>(<span class="hljs-built_in">config</span>.wwwDir));

<span class="hljs-comment">// 开启服务</span>
app.<span class="hljs-built_in">listen</span>(port, () =&gt; <span class="hljs-built_in">config</span>.logger.info(`server started at http:<span class="hljs-comment">//localhost:${ port }`));</span>
</code></pre>
<h2 id="node-js-">Node.js 示例</h2>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> stencil = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@stencil/core/server'</span>);

<span class="hljs-comment">// 载入 stencil 设置</span>
<span class="hljs-keyword">const</span> config = stencil.loadConfig(__dirname);

<span class="hljs-comment">// 创建渲染器</span>
<span class="hljs-keyword">const</span> renderer = stencil.createRenderer(config);

<span class="hljs-keyword">let</span> srcIndexHtml: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 载入 index.html</span>
  srcIndexHtml = fs.readFileSync(config.srcIndexHtml, <span class="hljs-string">'utf-8'</span>);

} <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`error loading srcIndexHtml: <span class="hljs-subst">${e}</span>`</span>);
}

<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span></span>) </span>{

  <span class="hljs-comment">// hydrate level 4, please!</span>
  renderer.hydrateToString({
    html: srcIndexHtml,
    req: req
  }).then(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {

    <span class="hljs-comment">// 记录诊断日志</span>
    results.diagnostics.forEach(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(d.messageText);
    });

    <span class="hljs-comment">// respond with the hydrated html</span>
    res.send(results.html);
  });
};
</code></pre>
<p><stencil-route-link url="/stencil-site/docs/prerendering" router="#router" custom="true">
  <button class="backButton">
    返回
  </button>
</stencil-route-link></p>
<p><stencil-route-link url="/stencil-site/docs/service-workers" custom="true">
  <button class="nextButton">
    继续
  </button>
</stencil-route-link></p>
